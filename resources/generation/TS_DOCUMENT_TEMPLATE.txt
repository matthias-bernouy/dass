import { ptr, read, toArrayBuffer, type Pointer } from "bun:ffi";
import { bufferPool256bytes } from "src/core/ObjectPool";
import { create_user_native, get_document_native } from "./src/lib/native_bridge/generated/dass-user.ts";
import { idToBuffer, SECRET_MASK } from "src/core/ffi/dass-dlopen.js";


export class Template {

    private pointer: Pointer;

    private constructor(element: Pointer){
        this.pointer = element;
    }

    get id(): string {
        // u64[0] is last_tx_id 
        const salt   = read.u64(this.pointer, 8);
        const others = read.u64(this.pointer, 16);
        
        const hidden = others ^ SECRET_MASK;
        
        return BigInt.asUintN(64, salt).toString(16).padStart(16, "0") + 
            BigInt.asUintN(64, hidden).toString(16).padStart(16, "0");
    }

//GETTERS

    delete(): boolean {
        // Call method
        return true;
    }

    save(): boolean {
        // Call method
        return true;
    }

    static create(/**CREATE_PARAMS*/ tx_id: bigint): Template | null {
        
        const bufferEmail    = bufferPool256bytes.acquire();
        const bufferFullname = bufferPool256bytes.acquire();
        const emailLength = bufferEmail.write(email);
        const fullnameLength = bufferFullname.write(fullname);

        const element = create_user_native(ptr(bufferEmail), emailLength, ptr(bufferFullname), fullnameLength, tx_id);

        bufferPool256bytes.release(bufferEmail);
        bufferPool256bytes.release(bufferFullname);

        if (element === null) return null;

        const element = new Template(userPtr);
        return element;
    }

    // String is stored as uuid format without dashes, so it should be 32 bytes long
    static findById(id: string): Template | null {
        const buffer = idToBuffer(id);
        if (id.length !== 32) {
            throw new Error("ID must be 32 characters long");
        }
        const doc = get_document_native(ptr(buffer));//Generated
        bufferPool256bytes.release(buffer);
        if (doc === null) return null;
        return new Template(doc);
    }

}